################################################################################
# Lijun Zhu's Tmux Configuration
################################################################################
# Modern configuration for tmux 3.6+
# Simplified and optimized for macOS with Alacritty

################################################################################
# General Settings
################################################################################

# Fast escape time for Vim
set -sg escape-time 0

# Display times
set -g display-time 2000
set -g display-panes-time 3000

# Increase repeat timeout
set -sg repeat-time 600

# Report focus events
set -s focus-events on

# History and buffers
set -g history-limit 50000
set -g buffer-limit 50

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Set terminal title
set -g set-titles on
set -g set-titles-string '#S:#W - tmux'

# Activity monitoring
set -g monitor-activity on
set -g visual-activity off
set -g bell-action any
set -g visual-bell off

################################################################################
# Key Bindings - Prefix
################################################################################

# Keep default Ctrl-b, add Ctrl-a as secondary prefix
set -g prefix2 C-a
bind C-a send-prefix -2

################################################################################
# Key Bindings - Configuration
################################################################################

# Reload configuration
bind r source-file ~/.tmux.conf \; display 'Config reloaded'

# Edit configuration in a new window
bind e new-window -n "tmux.conf" "sh -c '\${EDITOR:-nvim} ~/.tmux.conf'"

################################################################################
# Key Bindings - Windows
################################################################################

# Create new window
bind c new-window -c "#{pane_current_path}"
bind C new-window -c "#{pane_current_path}" \; command-prompt -I "#W" "rename-window '%%'"

# Rename window
bind , command-prompt -I "#W" "rename-window '%%'"

# Kill window
bind X confirm-before -p "kill-window #W? (y/n)" kill-window

################################################################################
# Key Bindings - Panes
################################################################################

# Split panes with intuitive keys (keep current path)
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Navigate panes vim-style
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Toggle pane zoom
bind z resize-pane -Z

# Kill pane without confirmation
bind x kill-pane

################################################################################
# Key Bindings - Copy Mode
################################################################################

# Enter copy mode
bind Enter copy-mode
bind Escape copy-mode

# Vi mode in copy mode
setw -g mode-keys vi

# Vi-style selection and copying
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# Mouse drag copies to clipboard
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# Copy on selection (like terminal)
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"

# Paste
unbind p
bind p paste-buffer
bind P choose-buffer

# List buffers
bind b list-buffers

################################################################################
# Key Bindings - Sessions
################################################################################

# Session management
bind S command-prompt -p "New Session:" "new-session -A -s '%%'"
bind K confirm-before -p "Kill session #S? (y/n)" kill-session

################################################################################
# Key Bindings - Misc
################################################################################

# Clear screen and history
bind C-l send-keys C-l \; clear-history

# Don't suspend client
unbind C-z

# Toggle status bar
bind t set status

################################################################################
# Display - Colors
################################################################################

# True color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",alacritty:RGB,xterm-256color:RGB"

# Undercurl support (for modern terminals)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

################################################################################
# Display - Status Bar
################################################################################

# Status bar position
set -g status-position bottom

# Update status bar every 5 seconds
set -g status-interval 5

# Status bar length
set -g status-left-length 50
set -g status-right-length 100

# Center window list
set -g status-justify centre

# Status bar colors (Modern minimal theme)
set -g status-style fg=white,bg=colour234

# Left status: session name and user
set -g status-left '#[fg=colour235,bg=colour252,bold] #S #[fg=colour252,bg=colour238,nobold]#[fg=colour245,bg=colour238,bold] #(whoami) #[fg=colour238,bg=colour234,nobold]'

# Right status: host and time
set -g status-right '#[fg=colour238,bg=colour234,nobold]#[fg=colour245,bg=colour238] #h #[fg=colour252]#[fg=colour235,bg=colour252,bold] %H:%M %d-%b '

# Window status
set -g window-status-format "#[fg=colour244,bg=colour234] #I #W "
set -g window-status-current-format "#[fg=colour234,bg=colour39]#[fg=colour234,bg=colour39,bold] #I #W #[fg=colour39,bg=colour234,nobold]"

# Window status activity
set -g window-status-activity-style fg=colour39,bg=colour234,bold

################################################################################
# Display - Panes
################################################################################

# Pane borders
set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour39

# Pane border status
set -g pane-border-status off
set -g pane-border-format "#[fg=colour244] #P: #{pane_current_command} "

################################################################################
# Display - Messages
################################################################################

# Message style
set -g message-style fg=colour16,bg=colour221,bold
set -g message-command-style fg=colour16,bg=colour221,bold

################################################################################
# Display - Modes
################################################################################

# Copy mode colors
set -g mode-style fg=colour16,bg=colour39,bold

################################################################################
# Display - Clock
################################################################################

# Clock mode (prefix + t)
setw -g clock-mode-colour colour39
setw -g clock-mode-style 24

################################################################################
# Automatic Window Renaming
################################################################################

# Rename windows automatically based on running program
setw -g automatic-rename on
setw -g automatic-rename-format '#{b:pane_current_path}'

################################################################################
# Plugins (Optional)
################################################################################

# To use TPM (Tmux Plugin Manager), uncomment below:
# set -g @plugin 'tmux-plugins/tpm'
# set -g @plugin 'tmux-plugins/tmux-sensible'
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
#
# # Initialize TPM (keep this at the very bottom)
# run '~/.tmux/plugins/tpm/tpm'

################################################################################
# Local Configuration Override
################################################################################

# Source local configuration if it exists
if-shell '[ -f ~/.tmux.conf.local ]' 'source ~/.tmux.conf.local'
